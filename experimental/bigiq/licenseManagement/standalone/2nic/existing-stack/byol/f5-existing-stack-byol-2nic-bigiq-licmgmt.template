{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Conditions": {
		"noCustomImageId": {
			"Fn::Equals": [
				"OPTIONAL",
				{
					"Ref": "customImageId"
				}
			]
		}
	},
	"Description": "Template v5.5.0 AWS CloudFormation Template for creating a 2NIC BIG-IQ in an existing VPC. **WARNING** This template creates Amazon EC2 Instances, you will be billed for the AWS resources created by this template.",
	"Mappings": {
		"regionMap": {
			"ap-northeast-1": {
				"Best": "ami-03796972da9048ab2"
			  },
			  "ap-northeast-2": {
				"Best": "ami-00007ebd9e15cb581"
			  },
			  "ap-south-1": {
				"Best": "ami-07f35c4b4760fb76f"
			  },
			  "ap-southeast-1": {
				"Best": "ami-0374f84dc0cc86cee"
			  },
			  "ap-southeast-2": {
				"Best": "ami-02126de94a8e4a605"
			  },
			  "ca-central-1": {
				"Best": "ami-0dd51fe2c81d4e7b0"
			  },
			  "cn-north-1": {
				"Best": "ami-03189b6fdb1ac423d"
			  },
			  "cn-northwest-1": {
				"Best": "ami-02778d25936e09f55"
			  },
			  "eu-central-1": {
				"Best": "ami-0653f874e93ba6682"
			  },
			  "eu-north-1": {
				"Best": "ami-48b13f36"
			  },
			  "eu-west-1": {
				"Best": "ami-0c95964ce0f5d45ac"
			  },
			  "eu-west-2": {
				"Best": "ami-0602be07b34c80953"
			  },
			  "sa-east-1": {
				"Best": "ami-00c1b0342af6d712b"
			  },
			  "us-east-1": {
				"Best": "ami-031d2878cb4d3fb48"
			  },
			  "us-east-2": {
				"Best": "ami-063ddf2d42d75365f"
			  },
			  "us-gov-east-1": {
				"Best": "ami-9b36d7ea"
			  },
			  "us-gov-west-1": {
				"Best": "ami-29d4b548"
			  },
			  "us-west-1": {
				"Best": "ami-0049e8ea793a198d9"
			  },
			  "us-west-2": {
				"Best": "ami-056accdfaf0533c43"
			  }
		}
	},
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [{
					"Label": {
						"default": "NETWORKING CONFIGURATION"
					},
					"Parameters": [
						"Vpc",
						"managementSubnetAz1",
						"subnet1Az1",
						"availabilityZone1"
					]
				},
				{
					"Label": {
						"default": "INSTANCE CONFIGURATION"
					},
					"Parameters": [
						"customImageId",
						"instanceType",
						"licenseKey1",
						"licensePoolKeys",
						"regPoolKeys",
						"bigIqPasswordS3Arn",
						"managementGuiPort",
						"sshKey",
						"restrictedSrcAddress",
						"restrictedSrcAddressApp",
						"ntpServer",
						"timezone"
					]
				},
				{
					"Label": {
						"default": "TAGS"
					},
					"Parameters": [
						"application",
						"environment",
						"group",
						"owner",
						"costcenter"
					]
				},
				{

				},
				{
					"Label": {
						"default": "TEMPLATE ANALYTICS"
					},
					"Parameters": [
						"allowUsageAnalytics"
					]
				}
			],
			"ParameterLabels": {
				"Vpc": {
					"default": "VPC"
				},
				"allowUsageAnalytics": {
					"default": "Send Anonymous Statistics to F5"
				},
				"application": {
					"default": "Application"
				},
				"availabilityZone1": {
					"default": "Availability Zone 1"
				},
				"costcenter": {
					"default": "Cost Center"
				},
				"customImageId": {
					"default": "Custom Image Id"
				},
				"environment": {
					"default": "Environment"
				},
				"group": {
					"default": "Group"
				},
				"instanceType": {
					"default": "AWS Instance Size"
				},
				"licenseKey1": {
					"default": "BIG-IQ License Key 1"
				},
				"bigIqPasswordS3Arn": {
					"default": "S3 ARN of the BIG-IQ Password File"
				},				
				"licensePoolKeys": {
					"default": "BIG-IP License Pool"
				},
				"regPoolKeys": {
					"default": "BIG-IP Reg Key Pool"
				},
				"managementGuiPort": {
					"default": "Management Port"
				},
				"managementSubnetAz1": {
					"default": "Management Subnet AZ1"
				},
				"ntpServer": {
					"default": "NTP Server"
				},
				"owner": {
					"default": "Owner"
				},
				"restrictedSrcAddress": {
					"default": "Source Address(es) for Management Access"
				},
				"restrictedSrcAddressApp": {
					"default": "Source Address(es) for internal Management Access"
				},
				"sshKey": {
					"default": "SSH Key"
				},
				"subnet1Az1": {
					"default": "Subnet1 in AZ1"
				},
				"timezone": {
					"default": "Timezone (Olson)"
				}
			}
		},
		"Version": "3.3.0-r12s2"
	},
	"Outputs": {
		"device1InternalInterfacePrivateIp": {
			"Description": "Internally routable IP of the public interface on the instance",
			"Value": {
				"Fn::GetAtt": [
					"device1subnet1Az1Interface",
					"PrimaryPrivateIpAddress"
				]
			}
		},
		"device1InstanceId": {
			"Description": "Instance Id of the instance in Amazon",
			"Value": {
				"Ref": "device1Instance"
			}
		},
		"device1ManagementEipAddress": {
			"Description": "IP address of the management port on the instance",
			"Value": {
				"Ref": "device1ManagementEipAddress"
			}
		},
		"device1ManagementInterface": {
			"Description": "Management interface ID on the instance",
			"Value": {
				"Ref": "device1ManagementInterface"
			}
		},
		"device1ManagementInterfacePrivateIp": {
			"Description": "Internally routable IP of the management interface on the instance",
			"Value": {
				"Fn::GetAtt": [
					"device1ManagementInterface",
					"PrimaryPrivateIpAddress"
				]
			}
		},
		"device1Url": {
			"Description": "Management GUI",
			"Value": {
				"Fn::Join": [
					"", [
						"https://",
						{
							"Fn::GetAtt": [
								"device1Instance",
								"PublicIp"
							]
						}
					]
				]
			}
		},
		"device1subnet1Az1EipAddress": {
			"Description": "Public IP address assigned to internal interface",
			"Value": {
				"Ref": "device1subnet1Az1EipAddress"
			}
		},
		"device1subnet1Az1Interface": {
			"Description": "Private interface Id on the instance",
			"Value": {
				"Ref": "device1subnet1Az1Interface"
			}
		},
		"availabilityZone1": {
			"Description": "Availability Zone",
			"Value": {
				"Fn::GetAtt": [
					"device1Instance",
					"AvailabilityZone"
				]
			}
		},
		"deviceManagementSecurityGroup": {
			"Description": "Management Security Group",
			"Value": {
				"Ref": "deviceManagementSecurityGroup"
			}
		},
		"deviceInternalSecurityGroup": {
			"Description": "Internal Security Group",
			"Value": {
				"Ref": "deviceInternalSecurityGroup"
			}
		}
	},
	"Parameters": {
		"Vpc": {
			"ConstraintDescription": "This must be an existing VPC within the working region.",
			"Type": "AWS::EC2::VPC::Id"
		},
		"allowUsageAnalytics": {
			"AllowedValues": [
				"Yes",
				"No"
			],
			"Default": "Yes",
			"Description": "This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you select **No** statistics are not sent.",
			"Type": "String"
		},
		"application": {
			"Default": "f5app",
			"Description": "Name of the Application Tag",
			"Type": "String"
		},
		"costcenter": {
			"Default": "f5costcenter",
			"Description": "Name of the Cost Center Tag",
			"Type": "String"
		},
		"customImageId": {
			"ConstraintDescription": "Must be a valid AMI Id",
			"Default": "OPTIONAL",
			"Description": "If you would like to deploy using a custom image, provide the AMI Id.  **Note**: Unless specifically required, leave the default of **OPTIONAL**",
			"MaxLength": 255,
			"MinLength": 1,
			"Type": "String"
		},
		"environment": {
			"Default": "f5env",
			"Description": "Name of the Environment Tag",
			"Type": "String"
		},
		"group": {
			"Default": "f5group",
			"Description": "Name of the Group Tag",
			"Type": "String"
		},
		"instanceType": {
			"AllowedValues": [
				"m4.xlarge",
				"m4.2xlarge",
				"m4.4xlarge"
			],
			"ConstraintDescription": "Must be a valid EC2 instance type for the instance",
			"Default": "m4.2xlarge",
			"Description": "Size of the F5 Instance",
			"Type": "String"
		},
		"licenseKey1": {
			"AllowedPattern": "([a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9}-[a-zA-Z0-9]{3,9})",
			"ConstraintDescription": "Verify your F5 BYOL registration key.",
			"Description": "F5 BIG-IQ license manager registration key",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String"
		},
		"licensePoolKeys": {
			"ConstraintDescription": "Verify your F5 BIG-IQ BIG-IP pool registration key.",
			"Description": "Enter a pool name and registration key using the format of name:key. Leave Do_Not_Create if you do not want to create a licensing pool on BIG-IQ at this time.",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String",
			"Default": "Do_Not_Create"
		},
		"regPoolKeys": {
			"ConstraintDescription": "Verify your F5 BIG-IQ pool BIG-IP registration keys.",
			"Description": "Enter a pool name and a list of individual BIG-IP registration keys in the format of name:key,key,key. Leave Do_Not_Create if you do not want to create a reg key pool on BIG-IQ at this time.",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String",
			"Default": "Do_Not_Create"
		},
		"managementSubnetAz1": {
			"ConstraintDescription": "The subnet ID must be within an existing VPC",
			"Description": "Management Subnet ID",
			"Type": "AWS::EC2::Subnet::Id"
		},
		"ntpServer": {
			"Default": "0.pool.ntp.org",
			"Description": "NTP server for this implementation",
			"Type": "String"
		},
		"owner": {
			"Default": "f5owner",
			"Description": "Name of the Owner Tag",
			"Type": "String"
		},
		"restrictedSrcAddress": {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x.",
			"Description": " The IP address range used to SSH and access management GUI on the EC2 instances",
			"MaxLength": "18",
			"MinLength": "9",
			"Type": "String"
		},
		"restrictedSrcAddressApp": {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x.",
			"Description": " The IP address range that can be used to access BIG-IQ on the specified internal network via port 443.",
			"MaxLength": "18",
			"MinLength": "9",
			"Type": "String"
		   },
		"sshKey": {
			"Description": "EC2 KeyPair to enable SSH access to the instance",
			"Type": "AWS::EC2::KeyPair::KeyName"
		},
		"subnet1Az1": {
			"ConstraintDescription": "The subnet ID must be within an existing VPC",
			"Description": "Private or Internal subnet",
			"Type": "AWS::EC2::Subnet::Id"
		},
		"timezone": {
			"Default": "UTC",
			"Description": "Olson timezone string from /usr/share/zoneinfo",
			"Type": "String"
		},
		"bigIqPasswordS3Arn": {
			"ConstraintDescription": "Verify the S3 ARN of BIG-IQ Password file",
			"Description": "S3 ARN of the BIG-IQ Password file. e.g. arn:aws:s3:::bucket_name/full_path_to_file for public regions. For GovCloud (US) region, start with arn:aws-us-gov:s3. For China region, start with arn:aws-cn:s3.",
			"MaxLength": "255",
			"MinLength": "1",
			"Type": "String"
		}		
	},
	"Resources": {
		"device1Instance": {
			"Metadata": {
				"AWS::CloudFormation::Init": {
					"config": {
						"commands": {
							"init": {
								"command": {
									"Fn::Join": [
										"", [
											"mkdir -p /var/log/cloud/aws;cat /config/cloud/initEncoded | /usr/bin/base64 -d > /config/cloud/init.sh && chmod +x /config/cloud/init.sh;",
											"/config/cloud/init.sh --cloud aws --log-level debug --data-interface eth1 --license ",
											{
												"Ref": "licenseKey1"
											},
											" --ntp ",
											{
												"Ref": "ntpServer"
											},
											" --timezone ",
											{
												"Ref": "timezone"
											},
											" --create-license-pool ",
											{
												"Ref": "licensePoolKeys"
											},
											" --create-reg-key-pool ",
											{
												"Ref": "regPoolKeys"
											},
											" --big-iq-password-data-uri ",
											{
												"Ref": "bigIqPasswordS3Arn"
											},											
											" --fcl-tag v4.17.1",
											" --fcl-cloud-tag v2.6.0",
											" --vlan 'n:internal,nic:1.1' ",
											" --self-ip 'n:internal_self,a:",
											{
												"Fn::GetAtt": [
													"device1subnet1Az1Interface",
													"PrimaryPrivateIpAddress"
												]
											},
											",v:internal,i:eth1'",
											" --usage-analytics 'send:",
											{
												"Ref": "allowUsageAnalytics"
											},
											",r:",
											{
												"Ref": "AWS::Region"
											},
											",cI:",
											{
												"Ref": "AWS::AccountId"
											},
											",dI:",
											{
												"Ref": "AWS::StackId"
											},
											",cN:aws,lT:byol,bIV:6.1.0,tN:f5-existing-stack-byol-2nic-bigiq,tV:5.5.0' ",
											"&>> /var/log/cloud/aws/install.log &"
										]
									]
								}
							}
						},
						"files": {
							"/config/cloud/initEncoded": {
								"group": "root",
								"mode": "000400",
								"owner": "root",
								"content": {
									"Fn::Join": [
										"", [
											"IyEvYmluL2Jhc2gKCiMjIyBDb25maWd1cmUgZGVmYXVsdCB2YWx1ZXMKbG9nX2xldmVsPSJpbmZvIgpoZWxwPWZhbHNlCnNraXBfdmVyaWZ5PWZhbHNlCnNjcmlwdF9kaXI9JChkaXJuYW1lICQwKQoKClRNU0g9L3Vzci9iaW4vdG1zaApDVVJMPS91c3IvYmluL2N1cmwKTk9ERT0vdXNyL2Jpbi9ub2RlCk1LRElSPS9iaW4vbWtkaXIKTU9VTlQ9L2Jpbi9tb3VudApSTURJUj0vYmluL3JtZGlyClVNT1VOVD0vYmluL3Vtb3VudAoKIyMjIEZ1bmN0aW9ucyAtIFRoZXNlIHNob3VsZCBnbyBpbnRvIHNlcGVyYXRlIGZpbGUocykKIyB1c2FnZTogbG9nIG1lc3NhZ2UKZnVuY3Rpb24gbG9nKCkgewogICAgZWNobyAiJChkYXRlICcrJVktJW0tJWRUJUg6JU06JVNaJyk6ICQxIgp9CiMgdXNhZ2U6IGdldF92ZXJzaW9uCmZ1bmN0aW9uIGdldF92ZXJzaW9uKCkgewogICAgcmV0PSQoJFRNU0ggc2hvdyBzeXMgdmVyc2lvbiB8IGdyZXAgLWkgcHJvZHVjdCB8IGF3ayAne3ByaW50ICQyfScpCiAgICBlY2hvICR7cmV0LCx9Cn0KIyB1c2FnZToganNvbmlmeSBrZXk6dmFsdWUsa2V5MTp2YWx1ZTEKZnVuY3Rpb24ganNvbmlmeSgpIHsKICAgIGxpc3Q9JChlY2hvICQxIHwgdHIgJywnICcgJykKICAgIGpzb249J3t9JwogICAgZm9yIGkgaW4gJGxpc3QgOyBkbwogICAgICAgIGt2PSgkKGVjaG8gJGkgfCB0ciAnOicgJyAnKSkKICAgICAgICBqc29uPSQoZWNobyAkanNvbiB8IGpxIC0tYXJnIGsgJHtrdlswXX0gLS1hcmcgdiAke2t2WzFdfSAnLiB8IC5bJGtdPSR2JykKICAgIGRvbmUKICAgIGVjaG8gJGpzb24KfQojIHVzYWdlOiBnZXRfdmFsIGpzb25fb2JqZWN0IGtleQpmdW5jdGlvbiBnZXRfdmFsKCkgewogICAgcmV0PSQoZWNobyAkMSB8IGpxIC4kMiAtcikKICAgIGVjaG8gJHJldAp9CiMgdXNhZ2U6IG1ha2Ugc3VyZSB0aGVyZSBpcyBpbnRlcm5ldCBjb25uZWN0aW9uIHRvIEdpdEh1YgpmdW5jdGlvbiBjaGVja19pbnRlcm5ldF9jb25uZWN0aW9uIHsKICAgIGVjaG8gIi0tLSBDaGVja2luZyBHaXRodWIgc3RhdHVzIC0tLSIKICAgIGNoZWNrcz0wCiAgICBnaXRodWJfcmVzcG9uc2U9ImJhZCIKICAgIHdoaWxlIFsgJGNoZWNrcyAtbHQgMTIwIF0gOyBkbwogICAgICAgIGdpdGh1Yl9yZXNwb25zZT1gY3VybCBodHRwczovL3d3dy5naXRodWJzdGF0dXMuY29tL2FwaS92Mi9zdGF0dXMuanNvbiB8IGpxIC5zdGF0dXMuZGVzY3JpcHRpb24gLS1yYXctb3V0cHV0YAogICAgICAgIGlmIFsgIiRnaXRodWJfcmVzcG9uc2UiID09ICJBbGwgU3lzdGVtcyBPcGVyYXRpb25hbCIgXTsgdGhlbgogICAgICAgICAgICBsb2cgIkdpdEh1YiBpcyByZWFkeSIKICAgICAgICAgICAgYnJlYWsKICAgICAgICBmaQogICAgICAgIGxvZyAiR2l0SHViIG5vdCByZWFkeTogJGNoZWNrcyIKICAgICAgICBsZXQgY2hlY2tzPWNoZWNrcysxCiAgICAgICAgc2xlZXAgNQogICAgZG9uZQogICAgaWYgWyAiJGdpdGh1Yl9yZXNwb25zZSIgPT0gImJhZCIgXTsgdGhlbgogICAgICAgIGxvZyAiTm8gR2l0SHViIGludGVybmV0IGNvbm5lY3Rpb24uIgogICAgICAgIGV4aXQKICAgIGZpCn0KIyB1c2FnZTogbWNwX3J1bm5pbmcKZnVuY3Rpb24gbWNwX3J1bm5pbmcgewogICAgY2hlY2tzPTAKICAgIHdoaWxlIFsgJGNoZWNrcyAtbHQgMTIwIF0gOyBkbwogICAgICAgICRUTVNIIC1hIHNob3cgc3lzIG1jcC1zdGF0ZSBmaWVsZC1mbXQgfCBncmVwIC1xIHJ1bm5pbmcKICAgICAgICBpZiBbICQ/ID09IDAgXTsgdGhlbgogICAgICAgICAgICBsb2cgIk1DUEQgcmVhZHkiCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZmkKICAgICAgICBsb2cgIk1DUEQgbm90IHJlYWR5OiAkY2hlY2tzIgogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCn0KIyB1c2FnZTogRG93bmxvYWQgZnJvbSBHaXRodWIgdW50aWwgc3VjY2Vzc2Z1bAojCiMgJDE6IG91dHB1dCBmaWxlIG5hbWUKIyAkMjogVVJMCmZ1bmN0aW9uIHNhZmVfZG93bmxvYWQgewogICAgY2hlY2tzPTAKICAgIHdoaWxlIFsgJGNoZWNrcyAtbHQgMTIwIF0gOyBkbwogICAgICAgICRDVVJMIC0tZmFpbCAtLXJldHJ5IDIwIC0tcmV0cnktZGVsYXkgNSAtLXJldHJ5LW1heC10aW1lIDI0MCAtbyAkMSAkMiAmJiBicmVhawogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCn0KIyB1c2FnZTogYmFzZV9jb25maWdfYXZhaWxhYmxlIC0gcmVzb2x2ZXMgaXNzdWUgZm91bmQgaW4gNi4wLjAgdmVyc2lvbnMgb2YgYmlnLWlxCmZ1bmN0aW9uIGJhc2VfY29uZmlnX2F2YWlsYWJsZSB7CiAgICBjaGVja3M9MAogICAgd2hpbGUgWyAkY2hlY2tzIC1sdCAxMjAgXSA7IGRvCiAgICAgICAgJFRNU0ggLWEgc2hvdyBzeXMgbWNwLXN0YXRlIGZpZWxkLWZtdCB8IGdyZXAgLXEgcnVubmluZwogICAgICAgIGlmIFsgLWYgL2NvbmZpZy9iaWdpcF9iYXNlLmNvbmYgXTsgdGhlbgogICAgICAgICAgICBsb2cgIkJhc2UgQ29uZmlnIGZpbGUgcHJlc2VudDsgc2F2aW5nIGNvbmZpZyIKICAgICAgICAgICAgdG1zaCBzYXZlIHN5cyBjb25maWcKICAgICAgICAgICAgY2F0IC9jb25maWcvYmlnaXBfYmFzZS5jb25mCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZmkKICAgICAgICBsb2cgIkJhc2UgY29uZmlnIGZpbGUgbm90IHlldCBwcmVzZW50OiAkY2hlY2tzIgogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCn0KIyB1c2FnZTogZ2V0X25ldF9pbmZvIGV0aDAgbnN8Z3cgaW5jbHVkZV9jaWRyCmZ1bmN0aW9uIGdldF9uZXRfaW5mbygpIHsKICAgIFJFVD0iIgogICAgQ0lEUl9CTE9DSz0iIgogICAgaWYgW1sgJGNsb3VkID09ICJhenVyZSIgXV07IHRoZW4KICAgICAgICBhZGRfaW50PTEKICAgICAgICBJRl9NQUM9JChpZmNvbmZpZyAkMSB8IGdyZXAgLWkgaHdhZGRyIHwgYXdrICd7cHJpbnQgJDV9JyB8IHNlZCAncy86Ly9nJykKICAgICAgICBJRl9JTkZPPSQoY3VybCAtc2YgLS1yZXRyeSAyMCBjdXJsIC1IIE1ldGFkYXRhOnRydWUgImh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbWV0YWRhdGEvaW5zdGFuY2UvbmV0d29yay9pbnRlcmZhY2U/YXBpLXZlcnNpb249MjAxNy0wOC0wMSIgfCBqcSAnLltdIHwgc2VsZWN0KC5tYWNBZGRyZXNzPT0iJyR7SUZfTUFDfSciKScpCiAgICAgICAgQ0lEUl9CTE9DSz0kKGVjaG8gJHtJRl9JTkZPfSB8IGpxIC5pcHY0LnN1Ym5ldFswXS5hZGRyZXNzIC0tcmF3LW91dHB1dCkKICAgICAgICBDSURSX0JMT0NLKz0iLyIKICAgICAgICBDSURSX0JMT0NLKz0kKGVjaG8gJHtJRl9JTkZPfSB8IGpxIC5pcHY0LnN1Ym5ldFswXS5wcmVmaXggLS1yYXctb3V0cHV0KQogICAgZWxpZiBbWyAkY2xvdWQgPT0gImF3cyIgXV07IHRoZW4KICAgICAgICBjaWRyX2Jsb2NrX3VyaT0idnBjLWlwdjQtY2lkci1ibG9jayIKICAgICAgICBhZGRfaW50PTIKICAgICAgICAjIElmIGdldHRpbmcgZ2F0ZXdheSwgdXBkYXRlIG5lY2Vzc2FyeSB2YXJzCiAgICAgICAgaWYgW1sgJDIgPT0gImd3IiBdXSA7IHRoZW4gY2lkcl9ibG9ja191cmk9InN1Ym5ldC1pcHY0LWNpZHItYmxvY2siIDsgYWRkX2ludD0xIDsgZmkKICAgICAgICBJRl9NQUM9JChpZmNvbmZpZyAkMSB8IGdyZXAgLWkgaHdhZGRyIHwgYXdrICd7cHJpbnQgdG9sb3dlcigkNSl9JykKICAgICAgICBDSURSX0JMT0NLPSQoY3VybCAtc2YgLS1yZXRyeSAyMCBodHRwOi8vMTY5LjI1NC4xNjkuMjU0L2xhdGVzdC9tZXRhLWRhdGEvbmV0d29yay9pbnRlcmZhY2VzL21hY3MvJHtJRl9NQUN9LyR7Y2lkcl9ibG9ja191cml9KQogICAgZmkKICAgIFJFVD0kKGVjaG8gJHtDSURSX0JMT0NLJS8qfSB8IGF3ayAtRi4gJ3sgcHJpbnRmICIlZC4lZC4lZC4lZCIsICQxLCAkMiwgJDMsICQ0Kycke2FkZF9pbnR9JyB9JykKICAgICMgSW5jbHVkZSBtYXNrIGluIHJlc3BvbnNlIGlmIHJlcXVlc3RlZAogICAgaWYgW1sgLW4gIiQzIiBdXSA7IHRoZW4gZWNobyAke1JFVH0vJHtDSURSX0JMT0NLIyovfSA7IGVsc2UgZWNobyAkUkVUIDsgZmkKfQojIGNyZWF0ZXMgYSBkaXJlY3RvcnkgZm9yIGluLW1lbW9yeSBmaWxlcwojIHVzYWdlOiBjcmVhdGVfdGVtcF9kaXIgbmFtZSBzaXplCmZ1bmN0aW9uIGNyZWF0ZV90ZW1wX2RpcigpIHsKICAgICRNS0RJUiAiJDEiCiAgICAkTU9VTlQgLXQgdG1wZnMgLW8gc2l6ZT0iJDIiLG1vZGU9MTcwMCB0bXBmcyAiJDEiCn0KIyB1c2FnZTogcmVtb3ZlX3RlbXBfZGlyIG5hbWUKZnVuY3Rpb24gcmVtb3ZlX3RlbXBfZGlyKCkgewogICAgJFVNT1VOVCAiJDEiCiAgICAkUk1ESVIgIiQxIgp9CiMgdXNhZ2U6IHdpcGVfdGVtcF9kaXIgbmFtZQpmdW5jdGlvbiB3aXBlX3RlbXBfZGlyKCkgewogICAgRklMRVM9JChscyAtMSAiJDEiKQoKICAgIGZvciBmIGluICRGSUxFUzsgZG8KICAgICAgICBzaHJlZCAtLXJlbW92ZSAiJHsxfS8ke2Z9IgogICAgZG9uZQoKICAgIHJlbW92ZV90ZW1wX2RpciAiJDEiCn0KCnJlYWQgLXIgLWQgJycgVVNBR0UgPDwgRU9NCiAgICBVc2FnZTogJDAKICAgICAgICAtLWhlbHAgICAgICAgICAgICAgICAgICAgICAgUHJpbnQgdXNhZ2UgbWVzc2FnZSBhbmQgZXhpdAogICAgICAgIC0tbG9nLWxldmVsIDxzdHJpbmc+ICAgICAgICBMZXZlbCBvZiBsb2dnaW5nIGRlc2lyZWQ6IGVycm9yLCB3YXJuLCBpbmZvLCBkZWJ1ZwogICAgICAgIC0tY2xvdWQgPHN0cmluZz4gICAgICAgICAgICBDbG91ZCBlbnZpcm9ubWVudCBleGVjdXRlZCBhZ2FpbnN0OiBhd3MKICAgICAgICAtLXNraXAtdmVyaWZ5IDxzdHJpbmc+ICAgICAgU2tpcCB2ZXJpZmljYXRpb24gb2YgZGVwZW5kZW5jaWVzCiAgICAgICAgLS1saWNlbnNlIDxzdHJpbmc+ICAgICAgICAgIExpY2Vuc2UgZm9yIHRoZSBkZXZpY2UKICAgICAgICAtLW50cCA8c3RyaW5nPiAgICAgICAgICAgICAgTlRQIGZvciB0aGUgZGV2aWNlCiAgICAgICAgLS10aW1lem9uZSA8c3RyaW5nPiAgICAgICAgIFRpbWV6b25lIGZvciB0aGUgZGV2aWNlCiAgICAgICAgLS1kYXRhLWludGVyZmFjZSA8c3RyaW5nPiAgIFByaW1hcnkgaW50ZXJmYWNlIHRvIHVzZSBmb3IgZGF0YS1wbGFuZQogICAgICAgIC0tdmxhbiA8c3RyaW5nPiAgICAgICAgICAgICBWTEFOKHMpIHRvIGNyZWF0ZSBvbiB0aGUgZGV2aWNlICg7IGZvciBtdWx0aXBsZSkgJ246ZXh0LG5pYzoxLjEnCiAgICAgICAgLS1zZWxmLWlwIDxzdHJpbmc+ICAgICAgICAgIFNlbGYgSVAocykgdG8gY3JlYXRlIG9uIHRoZSBkZXZpY2UgKDsgZm9yIG11bHRpcGxlKTogJ246ZXh0LGE6eC54LngueCx2OmV4dCxpOmV0aDEnCiAgICAgICAgLS11c2FnZS1hbmFseXRpY3MgPHN0cmluZz4gIFVzYWdlIGFuYWx5dGljcyB0byBzZW5kOiAnY046dmFsLHI6dmFsLGNJOnZhbCxkSTp2YWwsbFQ6dmFsLGJJVjp2YWwsdE46dmFsLHRWOnZhbCxzZW5kOnllcycKICAgICAgICAtLWNyZWF0ZS1saWNlbnNlLXBvb2wgICAgICAgQ3JlYXRlcyBsaWNlbnNlIHBvb2wsIHNlbmQ6IG5hbWU6cmVnX2tleQogICAgICAgIC0tY3JlYXRlLXJlZy1rZXktcG9vbCAgICAgICBDcmVhdGVzIGEgcmVna2V5IHBvb2wsIHNlbmQ6IG5hbWU6cmVnX2tleV9saXN0CiAgICAgICAgLS1mY2wtdGFnICAgICAgICAgICAgICAgICAgIEY1IGNsb3VkIGxpYiB0YWcgdG8gZG93bmxvYWQgZjUtY2xvdWQtbGlicy50YXIuZ3oKICAgICAgICAtLWZjbC1jbG91ZC10YWcgICAgICAgICAgICAgRjUgc3BlY2lmaWVkIGNsb3VkIHRhZyB0byBkb3dubG9hZCBmNS1jbG91ZC1saWJzLTxjbG91ZD4udGFyLmd6CiAgICAgICAgLS1iaWctaXEtcGFzc3dvcmQgICAgICAgICAgIEJpZ2lxIHBhc3N3b3JkLCB1c2VkIHRvIG9uYm9hcmQgYmlnaXEgY2x1c3RlcnMKICAgICAgICAtLWJpZy1pcS1tYXN0ZXIta2V5ICAgICAgICAgQmlnLUlRIG1hc3RlcmtleSB1c2VkIGR1cmluZyBpbml0aXRpYWwgY29uZmlndXJhaXRvbgogICAgICAgIC0tYmlnLWlxLXBhc3N3b3JkLWRhdGEtdXJpICBVUkkgdG8gdGhlIGxvY2F0aW9uIHRoYXQgY29udGFpbnMgQklHLUlRIGFkbWluIHVzZXIgcGFzc3dvcmQKICAgICAgICAtLW1hc3RlciAgICAgICAgICAgICAgICAgICAgSW5kaWNhdGVzIHRoYXQgdGhpcyBpbnN0YW5jZSBpcyBtYXN0ZXIgKHVzZWQgaW4gQklHLUlRIGNsdXN0ZXJpbmcpIHVzZSB3aXRoIC0tYmlnLWlxLWZhaWxvdmVyLXBlZXItaXAgb3B0aW9uCiAgICAgICAgLS1iaWctaXEtZmFpbG92ZXItcGVlci1pcCAgIFRoaXMgaXMgdGhlIHByaXZhdGUgSVAgYWRkcmVzcyBmb3IgdGhlIHNlY29uZGFyeSBCSUctSVEKICAgICAgICAtLXRhZy12YWx1ZSAgICAgICAgICAgICAgICAgVGhlIHRhZyB2YWx1ZSB0byBhZGQgdG8gdGhlIEVsYXN0aWMgdmlydHVhbCBJUCBhZGRyZXNzCiAgICAgICAgLS12aXAtYWxsb2NhdGlvbi1pZCAgICAgICAgIEFsbG9jYXRpb24gSUQgb2YgdGhlIEVsYXN0aWMgdmlydHVhbCBJUCBhZGRyZXNzCiAgICAgICAgLS1wcml2YXRlLWlwICAgICAgICAgICAgICAgIFByaXZhdGUgSVAgYWRkcmVzcyBhc3NvY2lhdGVkIHdpdGggdGhlIEVsYXN0aWMgdmlydHVhbCBJUCBhZGRyZXNzCiAgICAgICAgLS1hc3NvY2lhdGUtZW5pICAgICAgICAgICAgIEVOSSBvZiB0aGUgbmV0d29yayBpbnRlcmZhY2UgdG8gYXNzb2NpYXRlIHRoZSBFbGFzdGljIHZpcnR1YWwgSVAgYWRkcmVzcyB3aXRoIGluIEFXUwogICAgICAgIC0tYXNzb2NpYXRlLWludGYgICAgICAgICAgICBOYW1lIG9mIHRoZSBuZXR3b3JrIGludGVyZmFjZSB0byBhc3NvY2lhdGUgdGhlIHZpcnR1YWwgSVAgYWRkcmVzcyB3aXRoIGluIEF6dXJlCiAgICAgICAgLS1kaXNzb2NpYXRlLWludGYgICAgICAgICAgIE5hbWUgb2YgdGhlIG5ldHdvcmsgaW50ZXJmYWNlIHRvIGRpc3NvY2lhdGUgdGhlIHZpcnR1YWwgSVAgYWRkcmVzcyBmcm9tIGluIEF6dXJlCgoKRU9NCgojIyMgUGFyc2UgY29tbWFuZCBsaW5lIGFyZ3VtZW50cwp3aGlsZSBbWyAkIyAtZ3QgMCBdXSA7IGRvCiAgICBjYXNlICIkMSIgaW4KICAgICAgICAtLWhlbHApCiAgICAgICAgICAgIGhlbHA9dHJ1ZQogICAgICAgICAgICBzaGlmdCA7OwogICAgICAgIC0tbG9nLWxldmVsKQogICAgICAgICAgICBsb2dfbGV2ZWw9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1jbG91ZCkKICAgICAgICAgICAgY2xvdWQ9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1za2lwLXZlcmlmeSkKICAgICAgICAgICAgc2tpcF92ZXJpZnk9dHJ1ZQogICAgICAgICAgICBzaGlmdCA7OwogICAgICAgIC0tbGljZW5zZSkKICAgICAgICAgICAgbGljZW5zZT0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLW50cCkKICAgICAgICAgICAgbnRwPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tdGltZXpvbmUpCiAgICAgICAgICAgIHRpbWV6b25lPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tZGF0YS1pbnRlcmZhY2UpCiAgICAgICAgICAgIGRhdGFfaW50ZXJmYWNlPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tdXNhZ2UtYW5hbHl0aWNzKQogICAgICAgICAgICB1c2FnZV9hbmFseXRpY3M9IiQyIgogICAgICAgICAgICBzaGlmdCA7OwogICAgICAgIC0tdmxhbikKICAgICAgICAgICAgdmxhbj0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLXNlbGYtaXApCiAgICAgICAgICAgIHNlbGZfaXA9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1kaXNjb3ZlcnktYWRkcmVzcykKICAgICAgICAgICAgZGlzY292ZXJ5X2FkZHJlc3M9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1jcmVhdGUtbGljZW5zZS1wb29sKQogICAgICAgICAgICBsaWNlbnNlX3Bvb2w9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1jcmVhdGUtcmVnLWtleS1wb29sKQogICAgICAgICAgICByZWdfa2V5X3Bvb2w9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1mY2wtdGFnKQogICAgICAgICAgICBmY2xfdGFnPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tZmNsLWNsb3VkLXRhZykKICAgICAgICAgICAgZmNsX2Nsb3VkX3RhZz0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWJpZy1pcS1wYXNzd29yZCkKICAgICAgICAgICAgYmlnaXFfcGFzc3dvcmQ9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1iaWctaXEtbWFzdGVyLWtleSkKICAgICAgICAgICAgYmlnaXFfbWFzdGVyX2tleT0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsgICAgICAgICAgICAgICAgCiAgICAgICAgLS1iaWctaXEtcGFzc3dvcmQtZGF0YS11cmkpCiAgICAgICAgICAgIHBhc3N3b3JkX2RhdGFfdXJpPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tbWFzdGVyKQogICAgICAgICAgICBtYXN0ZXI9dHJ1ZQogICAgICAgICAgICBzaGlmdCA7OwogICAgICAgIC0tYmlnLWlxLWZhaWxvdmVyLXBlZXItaXApCiAgICAgICAgICAgIGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tdGFnLXZhbHVlKQogICAgICAgICAgICB0YWdfdmFsdWU9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS12aXAtYWxsb2NhdGlvbi1pZCkKICAgICAgICAgICAgdmlwX2FsbG9jYXRpb25faWQ9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1wcml2YXRlLWlwKQogICAgICAgICAgICBwcml2YXRlX2lwPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tYXNzb2NpYXRlLWVuaSkKICAgICAgICAgICAgYXNzb2NpYXRlX2VuaT0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWFzc29jaWF0ZS1pbnRmKQogICAgICAgICAgICBhc3NvY2lhdGVfaW50Zj0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWRpc3NvY2lhdGUtaW50ZikKICAgICAgICAgICAgZGlzc29jaWF0ZV9pbnRmPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgICp8LS0pCiAgICAgICAgICAgIHNoaWZ0CiAgICAgICAgICAgIGJyZWFrIDs7CiAgICBlc2FjCmRvbmUKCmlmICRoZWxwIDsgdGhlbgogICAgZWNobyAiJFVTQUdFIgogICAgZXhpdApmaQoKIyBWZXJpZnkgcmVxdWlyZWQgcGFyYW1ldGVycwpyZXF1aXJlZD0oImNsb3VkIikKZm9yIGkgaW4gJHtyZXF1aXJlZFtAXX0gOyBkbwogICAgaWYgWyAteiAkeyFpfSBdIDsgdGhlbgogICAgICAgIGxvZyAiQSByZXF1aXJlZCBwYXJhbWV0ZXIgaXMgbWlzc2luZzogJGkiCiAgICAgICAgZXhpdAogICAgZmkKZG9uZQoKY29uZmlnX3BhcmFtcz0iLS1oZWxwICRoZWxwIC0tbG9nLWxldmVsICRsb2dfbGV2ZWwgLS1jbG91ZCAkY2xvdWQgLS1za2lwLXZlcmlmeSAkc2tpcF92ZXJpZnkgLS1saWNlbnNlICRsaWNlbnNlIC0tbnRwICRudHAgLS10aW1lem9uZSAkdGltZXpvbmUgIC0tZGF0YS1pbnRlcmZhY2UgJGRhdGFfaW50ZXJmYWNlIC0tdXNhZ2UtYW5hbHl0aWNzICR1c2FnZV9hbmFseXRpY3MgLS12bGFuICR2bGFuIC0tc2VsZi1pcCAkc2VsZl9pcCAtLWRpc2NvdmVyeS1hZGRyZXNzICRkaXNjb3ZlcnlfYWRkcmVzcyAtLWNyZWF0ZS1saWNlbnNlLXBvb2wgJGxpY2Vuc2VfcG9vbCAtLWNyZWF0ZS1yZWcta2V5LXBvb2wgJHJlZ19rZXlfcG9vbCAtLWZjbC10YWcgJGZjbF90YWcgLS1mY2wtY2xvdWQtdGFnICRmY2xfY2xvdWRfdGFnICIKCiMgQ2hlY2sgZm9yIGVtcHR5IHZhcnM7IGFkZCB0byBjb25maWdfcGFybXMgaXMgbm90IGVtcHR5CltbICEgLXogIiRtYXN0ZXIiIF1dICYmIGNvbmZpZ19wYXJhbXMrPSIgLS1tYXN0ZXIgJG1hc3RlciAiCltbICEgLXogIiRiaWdpcV9tYXN0ZXJfa2V5IiBdXSAmJiBjb25maWdfcGFyYW1zKz0iIC0tYmlnLWlxLW1hc3Rlci1rZXkgJGJpZ2lxX21hc3Rlcl9rZXkgIgpbWyAhIC16ICIkcGFzc3dvcmRfZGF0YV91cmkiIF1dICYmIGNvbmZpZ19wYXJhbXMrPSIgLS1iaWctaXEtcGFzc3dvcmQtZGF0YS11cmkgJHBhc3N3b3JkX2RhdGFfdXJpICIKW1sgISAteiAiJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwIiBdXSAmJiBjb25maWdfcGFyYW1zKz0iIC0tYmlnLWlxLWZhaWxvdmVyLXBlZXItaXAgJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwICIKZWNobyAiQ29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzOiAke2NvbmZpZ19wYXJhbXMvJGJpZ2lxX21hc3Rlcl9rZXkvT2JmdXNjYXRlZH0iCiMgQ2hlY2sgZm9yICJEbyBOb3QgQ3JlYXRlIiBpbiBjcmVhdGUgcG9vbCBwYXJtZXRlcnMKc2hvcHQgLXMgbm9jYXNlbWF0Y2gKaWYgW1sgJGxpY2Vuc2VfcG9vbCA9PSAiRG9fTm90X0NyZWF0ZSIgXV0gOyB0aGVuCiAgICBsb2cgIlNldHRpbmcgbGljZW5zaW5nIHBvb2wgdG8gbnVsbCBhcyAnRG9fTm90X0NyZWF0ZScgaGFzIGJlZW4gc3BlY2lmaWVkOiAkbGljZW5zaW5nX3Bvb2wiCiAgICBsaWNlbnNlX3Bvb2w9IiIKZmkKaWYgW1sgJHJlZ19rZXlfcG9vbCA9PSAiRG9fTm90X0NyZWF0ZSIgXV0gOyB0aGVuCiAgICBsb2cgIlNldHRpbmcgcmVnIGtleSBwb29sIHRvIG51bGwgYXMgJ0RvX05vdF9DcmVhdGUnIGhhcyBiZWVuIHNwZWNpZmllZDogJGxpY2Vuc2luZ19wb29sIgogICAgcmVnX2tleV9wb29sPSIiCmZpCnNob3B0IC11IG5vY2FzZW1hdGNoCgojIyMgSW5zdGFsbCBkZXBlbmRlbmNpZXMgIyMjCiMjIFRoZXJlIG11c3QgYmUgR2l0SHViIGludGVybmV0IGNvbm5lY3Rpb24KY2hlY2tfaW50ZXJuZXRfY29ubmVjdGlvbgoKYmFzZV91cmw9Imh0dHA6Ly9jZG4uZjUuY29tL3Byb2R1Y3QvY2xvdWRzb2x1dGlvbnMiCmJhc2VfZGlyPSIvY29uZmlnL2Nsb3VkIgpiYXNlX2xvZ19kaXI9Ii92YXIvbG9nL2Nsb3VkLyR7Y2xvdWR9IgpiYXNlX2RlcGVuZGVuY3lfZGlyPSIke2Jhc2VfZGlyfS8ke2Nsb3VkfS9ub2RlX21vZHVsZXMvQGY1ZGV2Y2VudHJhbCIKCiMjIERvd25sb2FkCmRlcGVuZGVuY2llcz0oIiR7YmFzZV91cmx9L2Y1LWNsb3VkLWxpYnMvJHtmY2xfdGFnfS9mNS1jbG91ZC1saWJzLnRhci5neiIpCmRlcGVuZGVuY2llcys9KCIke2Jhc2VfdXJsfS9mNS1jbG91ZC1saWJzLSR7Y2xvdWR9LyR7ZmNsX2Nsb3VkX3RhZ30vZjUtY2xvdWQtbGlicy0ke2Nsb3VkfS50YXIuZ3oiKQpkZXBlbmRlbmNpZXMrPSgiJHtiYXNlX3VybH0vZjUtY2xvdWQtbGlicy8ke2ZjbF90YWd9L3ZlcmlmeUhhc2giKQoKZm9yIGkgaW4gJHtkZXBlbmRlbmNpZXNbQF19IDsgZG8KICAgIGxvZyAiRG93bmxvYWRpbmcgZGVwZW5kZW5jeTogJGkiCiAgICBmPSQoYmFzZW5hbWUgJGkpCiAgICBzYWZlX2Rvd25sb2FkICR7YmFzZV9kaXJ9LyRmICRpCiAgICAjICRDVVJMIC1rc2YgLS1yZXRyeSAxMCAtLXJldHJ5LWRlbGF5IDUgLS1yZXRyeS1tYXgtdGltZSAyNDAgLW8gJHtiYXNlX2Rpcn0vJGYgJGkKZG9uZQoKIyMgVmVyaWZ5CiMgTUNQIG11c3QgYmUgcnVubmluZyBmaXJzdAptY3BfcnVubmluZwpiYXNlX2NvbmZpZ19hdmFpbGFibGUKCmlmICEgJHNraXBfdmVyaWZ5IDsgdGhlbgogICAgdmVyaWZ5X3NjcmlwdD0iJHtiYXNlX2Rpcn0vdmVyaWZ5SGFzaCIKICAgIGlmICEgJFRNU0ggbG9hZCBzeXMgY29uZmlnIG1lcmdlIGZpbGUgJHZlcmlmeV9zY3JpcHQgOyB0aGVuCiAgICAgICAgbG9nICJDTEkgdmVyaWZpY2F0aW9uIHNjcmlwdCBpcyBub3QgdmFsaWQ6ICR2ZXJpZnlfc2NyaXB0IgogICAgICAgIGV4aXQgMQogICAgZmkKCiAgICBmb3IgaSBpbiAke2RlcGVuZGVuY2llc1tAXX0gOyBkbwogICAgICAgIGY9JChiYXNlbmFtZSAkaSkKICAgICAgICBpZiBbWyAkZiAhPSAidmVyaWZ5SGFzaCIgXV0gOyB0aGVuCiAgICAgICAgICAgIGxvZyAiVmVyaWZ5aW5nIGRlcGVuZGVuY3k6ICRmIgogICAgICAgICAgICBpZiAhICRUTVNIIHJ1biBjbGkgc2NyaXB0IHZlcmlmeUhhc2ggIi9jb25maWcvY2xvdWQvJGYiIDsgdGhlbgogICAgICAgICAgICAgICAgbG9nICJEZXBlbmRlbmN5IGlzIG5vdCB2YWxpZDogJGYiCiAgICAgICAgICAgICAgICBleGl0IDEKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZG9uZQplbHNlCiAgICBsb2cgIldhcm5pbmc6IFNraXBwaW5nIGRlcGVuZGVuY3kgdmVyaWZpY2F0aW9uIgpmaQoKIyMgSW5zdGFsbApta2RpciAtcCAkYmFzZV9kZXBlbmRlbmN5X2Rpcgpmb3IgaSBpbiAke2RlcGVuZGVuY2llc1tAXX0gOyBkbwogICAgZj0kKGJhc2VuYW1lICRpKQogICAgbG9nICJJbnN0YWxsaW5nIGRlcGVuZGVuY3k6ICRmIgogICAgaWYgW1sgJGYgPT0gKiIudGFyIiogXV0gOyB0aGVuCiAgICAgICAgdGFyIHhmeiAke2Jhc2VfZGlyfS8ke2Z9IC1DICRiYXNlX2RlcGVuZGVuY3lfZGlyCiAgICBmaQpkb25lCgojIyBTaWduYWwKdG91Y2ggIiR7YmFzZV9kaXJ9L2Nsb3VkTGlic1JlYWR5IgoKIyBDcmVhdGUgdG1wIGJpZy1pcSBwYXNzd29yZCBmaWxlLiBSZXF1aXJlZCBmb3IgQXp1cmUgYmlnLWlxIGNsdXN0ZXJpbmcuCmlmIFsgLW4gIiRiaWdpcV9wYXNzd29yZCIgXSA7IHRoZW4KICAgIGVjaG8gJ0NyZWF0aW5nIGJpZ2lxIHRlbXBvcmFyeSBwYXNzd29yZCBmaWxlLicKICAgIHRtcF9maWxlPScvbW50L2Nsb3VkVG1wLy5iaWdpcV9wYXNzJwogICAgdG1wX2Rpcj0kKGRpcm5hbWUgJHRtcF9maWxlKQogICAgY3JlYXRlX3RlbXBfZGlyICR0bXBfZGlyCiAgICBlY2hvICJ7IFwibWFzdGVyUGFzc3BocmFzZVwiOiBcIiR7YmlnaXFfbWFzdGVyX2tleX1cIixcInJvb3RcIjogXCIke2JpZ2lxX3Bhc3N3b3JkfVwiLFwiYWRtaW5cIjogXCIke2JpZ2lxX3Bhc3N3b3JkfVwiIH0iID4gJHRtcF9maWxlCmZpCiMjIyBQcm92aXNpb24gRGV2aWNlICMjIwpta2RpciAtcCAkYmFzZV9sb2dfZGlyCmhvc3RuYW1lPSIiCmlmIFtbICRjbG91ZCA9PSAiYXdzIiBdXTsgdGhlbgogICAgaG9zdG5hbWU9JCgkQ1VSTCAtc2YgLS1yZXRyeSAyMCBodHRwOi8vMTY5LjI1NC4xNjkuMjU0L2xhdGVzdC9tZXRhLWRhdGEvaG9zdG5hbWUpCmVsaWYgW1sgJGNsb3VkID09ICJhenVyZSIgXV07IHRoZW4KICAgIG1ldGFkYXRhPSQoJENVUkwgLUggTWV0YWRhdGE6dHJ1ZSAiaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9tZXRhZGF0YS9pbnN0YW5jZS9jb21wdXRlP2FwaS12ZXJzaW9uPTIwMTctMTItMDEiKQogICAgaG9zdG5hbWU9JChlY2hvICR7bWV0YWRhdGF9IHwganEgLm5hbWUgLS1yYXctb3V0cHV0KQogICAgaG9zdG5hbWUrPSIuIgogICAgaG9zdG5hbWUrPSQoZWNobyAke21ldGFkYXRhfSB8IGpxIC5sb2NhdGlvbiAtLXJhdy1vdXRwdXQpCiAgICBob3N0bmFtZSs9Ii5jbG91ZGFwcC5henVyZS5jb20iCmZpCmhvc3Q9ImxvY2FsaG9zdCIKc2VwYXJhdG9yPSI7IgoKIyBDb3VsZCB1c2UgYSBnZW5lcmljIC0tb25ib2FyZHwtLW5ldHdvcmt8ZXRjIGZvciBvcHRpb25hbCBhcmd1bWVudHMKIyBpbnN0ZWFkLCBhdCBsZWFzdCBmb3Igbm93IGltcGxlbWVudCB0aGUgYWRkaXRpb25hbCBhYnN0cmFjdGlvbgoKIyMgT25ib2FyZApvbmJvYXJkX2FyZ3M9IiIKaWYgWyAtbiAiJGNsb3VkIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLWNsb3VkICR7Y2xvdWR9ICIgOyBmaQppZiBbIC1uICIkbGljZW5zZSIgXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1saWNlbnNlICR7bGljZW5zZX0gIiA7IGZpCmlmIFsgLW4gIiRudHAiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tbnRwICR7bnRwfSAiIDsgZmkKaWYgWyAtbiAiJHRpbWV6b25lIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLXR6ICR7dGltZXpvbmV9ICIgOyBmaQppZiBbIC1uICIkbGljZW5zZV9wb29sIiBdIDsgdGhlbgogICAgIyBDaGVjayBmb3IgbXVsaXRpcGxlIGxpY2Vuc2UgcG9vbHMKICAgIE9JRlM9JElGUwogICAgSUZTPSIsIjsKICAgIGxpY2Vuc2VBcnJheT0oJGxpY2Vuc2VfcG9vbCk7CiAgICBmb3IgaSBpbiAke2xpY2Vuc2VBcnJheVtAXX07IGRvCiAgICAgICAgZmxhZz0nIC0tY3JlYXRlLWxpY2Vuc2UtcG9vbCAnCiAgICAgICAgY2F0X2FyZ3M9IiR7Y2F0X2FyZ3N9JHtmbGFnfSRpIgogICAgZG9uZQogICAgSUZTPSRPSUZTOwogICAgb25ib2FyZF9hcmdzKz0iJHtjYXRfYXJnc30gIiA7IGZpCgppZiBbIC1uICIkcmVnX2tleV9wb29sIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLWNyZWF0ZS1yZWcta2V5LXBvb2wgJHtyZWdfa2V5X3Bvb2x9ICIgOyBmaQoKaWYgW1sgJGNsb3VkID09ICJhd3MiIF1dOyB0aGVuCiAgICBpZiBbIC1uICIkZGF0YV9pbnRlcmZhY2UiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tZG5zICQoZ2V0X25ldF9pbmZvICRkYXRhX2ludGVyZmFjZSBucykgIiA7IGZpCmVsaWYgW1sgJGNsb3VkID09ICJhenVyZSIgXV07IHRoZW4KICAgIGlmIFsgLW4gIiRkYXRhX2ludGVyZmFjZSIgXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1kbnMgMTY4LjYzLjEyOS4xNiAiIDsgZmkKZmkKCmlmIFtbICIkKGdldF92ZXJzaW9uKSIgPT0gImJpZy1pcSIgJiYgLW4gIiRwYXNzd29yZF9kYXRhX3VyaSIgXV07IHRoZW4KICAgIG9uYm9hcmRfYXJncys9Ii0tYmlnLWlxLXBhc3N3b3JkLWRhdGEtdXJpICR7cGFzc3dvcmRfZGF0YV91cml9ICIKZWxpZiBbWyAiJChnZXRfdmVyc2lvbikiID09ICJiaWctaXEiIF1dOyB0aGVuCiAgICBvbmJvYXJkX2FyZ3MrPSItLXNldC1tYXN0ZXIta2V5ICIKZmkKCmlmIFsgLW4gIiR1c2FnZV9hbmFseXRpY3MiIF0gOyB0aGVuCiAgICBvPSQoanNvbmlmeSAkdXNhZ2VfYW5hbHl0aWNzKQogICAgIyBPYmZ1c2NhdGUgc2Vuc2l0aXZlIGluZm9ybWF0aW9uCiAgICBjST0kKGVjaG8gJChnZXRfdmFsICIkbyIgY0kpIHwgc2hhNTEyc3VtIHwgY3V0IC1kICIgIiAtZiAxKQogICAgZEk9JChlY2hvICQoZ2V0X3ZhbCAiJG8iIGRJKSB8IHNoYTUxMnN1bSB8IGN1dCAtZCAiICIgLWYgMSkKICAgIG1ldHJpY3MrPSJjbG91ZE5hbWU6JChnZXRfdmFsICIkbyIgY04pLHJlZ2lvbjokKGdldF92YWwgIiRvIiByKSxjdXN0b21lcklkOiR7Y0l9IgogICAgbWV0cmljcys9IixkZXBsb3ltZW50SWQ6JHtkSX0sbGljZW5zZVR5cGU6JChnZXRfdmFsICIkbyIgbFQpLGJpZ0lwVmVyc2lvbjokKGdldF92YWwgIiRvIiBiSVYpIgogICAgbWV0cmljcys9Iix0ZW1wbGF0ZU5hbWU6JChnZXRfdmFsICIkbyIgdE4pLHRlbXBsYXRlVmVyc2lvbjokKGdldF92YWwgIiRvIiB0VikgIgogICAgc2VuZF9hbmFseXRpY3M9JChnZXRfdmFsICIkbyIgc2VuZCkKICAgIGlmIFtbICIke3NlbmRfYW5hbHl0aWNzLCx9IiA9PSAieWVzIiBdXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1tZXRyaWNzICRtZXRyaWNzICIgOyBmaQpmaQoKJE5PREUgIiR7YmFzZV9kZXBlbmRlbmN5X2Rpcn0vZjUtY2xvdWQtbGlicy9zY3JpcHRzL29uYm9hcmQuanMiIC0taG9zdCAkaG9zdCAtLWxvZy1sZXZlbCAkbG9nX2xldmVsIFwKICAgIC0tb3V0cHV0ICIke2Jhc2VfbG9nX2Rpcn0vb25ib2FyZC5sb2ciIC0tc2lnbmFsIE9OQk9BUkRfRE9ORSAtLWhvc3RuYW1lICRob3N0bmFtZSAkb25ib2FyZF9hcmdzICY+PiAke2Jhc2VfbG9nX2Rpcn0vaW5zdGFsbC5sb2cKCiMgVE9ETzogUmFjZSBjb25kaXRpb24gYmV0d2VlbiBvbmJvYXJkL25ldHdvcmsgLSBVc2luZyBhdXRoIHRva2VuIHJlc3VsdHMgaW4gNDAzICJub3QgYXV0aG9yaXplZCIKIyBpZiBuZXR3b3JrIGNhbGwgaW1tZWRpYXRlbHkgZm9sbG93cyBvbmJvYXJkLiAgVXNlIGZvbGxvd2luZyBwbGFjZWhvbGRlciB1bnRpbCBmaXhlZCBpbiBmNS1jbG91ZC1saWJzCiMgYWRkaW5nIC0td2FpdC1mb3Igc2lnbmFsIGZvciBuZXR3b3JrIGNhbGwuCndhaXRfdGltZT0zMApsb2cgIldhaXRpbmc6ICR3YWl0X3RpbWUiCnNsZWVwICR3YWl0X3RpbWUKCiMjIE5ldHdvcmsKZWNobyAiQ29uZmlndXJpbmcgbmV0d29yay4uLiIKbmV0d29ya19hcmdzPSIiCmlmIFsgLW4gIiRkYXRhX2ludGVyZmFjZSIgXSA7IHRoZW4gbmV0d29ya19hcmdzKz0iLS1kZWZhdWx0LWd3ICQoZ2V0X25ldF9pbmZvICRkYXRhX2ludGVyZmFjZSBndykgIiA7IGZpCmlmIFsgLW4gIiR2bGFuIiBdIDsgdGhlbgogICAgZm9yIGkgaW4gJChlY2hvICR2bGFuIHwgdHIgIiRzZXBhcmF0b3IiICcgJykgOyBkbwogICAgICAgIG89JChqc29uaWZ5ICRpKQogICAgICAgIG5ldHdvcmtfYXJncys9Ii0tdmxhbiBuYW1lOiQoZ2V0X3ZhbCAiJG8iIG4pLG5pYzokKGdldF92YWwgIiRvIiBuaWMpICIKICAgIGRvbmUKZmkKaWYgWyAtbiAiJHNlbGZfaXAiIF0gOyB0aGVuCiAgICBmb3IgaSBpbiAkKGVjaG8gJHNlbGZfaXAgfCB0ciAiJHNlcGFyYXRvciIgJyAnKSA7IGRvCiAgICAgICAgbz0kKGpzb25pZnkgJGkpCiAgICAgICAgZ3c9JChnZXRfbmV0X2luZm8gJChnZXRfdmFsICIkbyIgaSkgZ3cgY2lkcikKICAgICAgICBuZXR3b3JrX2FyZ3MrPSItLXNlbGYtaXAgbmFtZTokKGdldF92YWwgIiRvIiBuKSxhZGRyZXNzOiQoZ2V0X3ZhbCAiJG8iIGEpLyR7Z3cjKi99LHZsYW46JChnZXRfdmFsICIkbyIgdikgIgogICAgZG9uZQpmaQppZiBbIC1uICIkZGlzY292ZXJ5X2FkZHJlc3MiIF0gOyB0aGVuCiAgICBuZXR3b3JrX2FyZ3MrPSItLWRpc2NvdmVyeS1hZGRyZXNzICR7ZGlzY292ZXJ5X2FkZHJlc3N9IgpmaQokTk9ERSAiJHtiYXNlX2RlcGVuZGVuY3lfZGlyfS9mNS1jbG91ZC1saWJzL3NjcmlwdHMvbmV0d29yay5qcyIgLS1ob3N0ICRob3N0IC0tbG9nLWxldmVsICRsb2dfbGV2ZWwgXAogICAgLS1vdXRwdXQgIiR7YmFzZV9sb2dfZGlyfS9uZXR3b3JrLmxvZyIgLS13YWl0LWZvciBPTkJPQVJEX0RPTkUgLS1zaWduYWwgTkVUV09SS19ET05FICRuZXR3b3JrX2FyZ3MgJj4+ICR7YmFzZV9sb2dfZGlyfS9pbnN0YWxsLmxvZwoKIyMgQWRkIHJvdXRlIHRvIEluc3RhbmNlIE1ldGFkYXRhIHNlcnZpY2UKIyBBbGxvdyBzeXN0ZW0gdG8gdXNlIElQdjQgbGluay1sb2NhbCBhZGRyZXNzZXMgaW4gbmV0d29yayByb3V0ZXMKdG1zaCBtb2RpZnkgc3lzIGRiIGNvbmZpZy5hbGxvdy5yZmMzOTI3IHZhbHVlIGVuYWJsZQoKIyBBZGQgcm91dGUgdG8gTWV0YWRhdGEgc2VydmljZQpnYXRld2F5PSQodG1zaCBsaXN0IHN5cyBtYW5hZ2VtZW50LXJvdXRlIGdhdGV3YXkgfCBncmVwIGdhdGV3YXkgfCBoZWFkIC1uIDEgfCBhd2sgJ3twcmludCAkMn0nKQp0bXNoIGNyZWF0ZSBzeXMgbWFuYWdlbWVudC1yb3V0ZSBtZXRhZGF0YSBuZXR3b3JrIDE2OS4yNTQuMTY5LjI1NC8zMiBnYXRld2F5ICRnYXRld2F5CgojIyBDbHVzdGVyCmlmIFtbIC1uICIkbWFzdGVyIiAmJiAtbiAiJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwIiBdXSA7IHRoZW4KICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGNsdXN0ZXIuLi4iCiAgICBjbHVzdGVyX2FyZ3M9Ii0tY2xvdWQgJGNsb3VkIC0tbWFzdGVyIC0tYmlnLWlxLWZhaWxvdmVyLXBlZXItaXAgJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwIgogICAgaWYgWyAtbiAiJHBhc3N3b3JkX2RhdGFfdXJpIiBdIDsgdGhlbgogICAgICAgIGNsdXN0ZXJfYXJncys9IiAtLWJpZy1pcS1wYXNzd29yZC1kYXRhLXVyaSAkcGFzc3dvcmRfZGF0YV91cmkgIgogICAgZmkKICAgICROT0RFICIke2Jhc2VfZGVwZW5kZW5jeV9kaXJ9L2Y1LWNsb3VkLWxpYnMvc2NyaXB0cy9jbHVzdGVyLmpzIiAtLWhvc3QgJGhvc3QgLS1sb2ctbGV2ZWwgJGxvZ19sZXZlbCBcCiAgICAgICAgLS1vdXRwdXQgIiR7YmFzZV9sb2dfZGlyfS9jbHVzdGVyLmxvZyIgLS11c2VyIGFkbWluICRjbHVzdGVyX2FyZ3MgJj4+ICR7YmFzZV9sb2dfZGlyfS9pbnN0YWxsLmxvZwpmaQoKIyBGYWlsb3ZlcgojIE9ubHkgcGVyZm9ybSBmYWlsb3ZlciBmb3IgY2x1c3RlciBzb2x1dGlvbgppZiBbWyAtbiAiJHRhZ192YWx1ZSIgXV0gOyB0aGVuCiAgICBmYWlsb3Zlcl9hcmdzPSItLWxvZy1sZXZlbCAkbG9nX2xldmVsIC0tbG9nLWZpbGUgL3Zhci9sb2cvY2xvdWQvJGNsb3VkL2ZhaWxvdmVyLmxvZyAtLXRhZy1rZXkgZjVfZGVwbG95bWVudCAiCiAgICBmYWlsb3Zlcl9hcmdzKz0iLS10YWctdmFsdWUgJHRhZ192YWx1ZSAiCgogICAgaWYgW1sgJGNsb3VkID09ICJhd3MiIF1dOyB0aGVuCiAgICAgICAgaWYgWyAtbiAiJHZpcF9hbGxvY2F0aW9uX2lkIiBdIDsgdGhlbgogICAgICAgIGZhaWxvdmVyX2FyZ3MrPSItLXZpcC1hbGxvY2F0aW9uLWlkICR2aXBfYWxsb2NhdGlvbl9pZCAiCiAgICAgICAgZmkKCiAgICAgICAgaWYgWyAtbiAiJHByaXZhdGVfaXAiIF0gOyB0aGVuCiAgICAgICAgICAgIGZhaWxvdmVyX2FyZ3MrPSItLXByaXZhdGUtaXAgJHByaXZhdGVfaXAgIgogICAgICAgIGZpCgogICAgICAgIGlmIFsgLW4gIiRhc3NvY2lhdGVfZW5pIiBdIDsgdGhlbgogICAgICAgICAgICBmYWlsb3Zlcl9hcmdzKz0iLS1hc3NvY2lhdGUtZW5pICRhc3NvY2lhdGVfZW5pICIKICAgICAgICBmaQoKICAgICAgICBpZiBbIC1uICIkcGFzc3dvcmRfZGF0YV91cmkiIF0gOyB0aGVuCiAgICAgICAgICAgIGZhaWxvdmVyX2FyZ3MrPSItLXBhc3N3b3JkLXVyaSAkcGFzc3dvcmRfZGF0YV91cmkgIgogICAgICAgIGZpCiAgICBmaQoKICAgICMgQXp1cmUgbmVlZHMgZXh0cmEgY2FyZXM6IGFmdGVyIGNsdXN0ZXJpbmcgaXMgZG9uZSwgYmlnaXEgdG1wIHBhc3N3b3JkIGZpbGUgd2lsbCBiZSBkZWxldGVkLCB3ZSBuZWVkIGJpZ2lxIHBhc3N3b3JkCiAgICAjIHRvIHBlcmZvcm0gZmFpbG92ZXIKICAgIGlmIFtbICRjbG91ZCA9PSAiYXp1cmUiIF1dOyB0aGVuCiAgICAgICAgaWYgWyAtbiAiJGJpZ2lxX3Bhc3N3b3JkIiBdIDsgdGhlbgogICAgICAgICAgICAjIyBJZiBjcmVhdGVkLCByZW1vdmUgYmlnaXEgdG1wIHBhc3N3b3JkIGZpbGUKICAgICAgICAgICAgdG1wX2ZpbGU9Jy9tbnQvY2xvdWRUbXAvLmJpZ2lxX3Bhc3MnCiAgICAgICAgICAgIHRtcF9kaXI9JChkaXJuYW1lICR0bXBfZmlsZSkKICAgICAgICAgICAgd2lwZV90ZW1wX2RpciAkdG1wX2RpcgogICAgICAgICAgICBlY2hvICdEZWxldGluZyBiaWdpcSB0ZW1wb3JhcnkgcGFzc3dvcmQgZmlsZS4nCiAgICAgICAgICAgICMgVXNlIGJpZ2lxIHBhc3N3b3JkIGZvciBmYWlsb3ZlciBzY3JpcHQKICAgICAgICAgICAgZmFpbG92ZXJfYXJncys9Ii0tcGFzc3dvcmQtZGF0YSAkYmlnaXFfcGFzc3dvcmQgIgogICAgICAgIGZpCiAgICAgICAgaWYgWyAtbiAiJGFzc29jaWF0ZV9pbnRmIiBdIDsgdGhlbgogICAgICAgIGZhaWxvdmVyX2FyZ3MrPSItLWFzc29jaWF0ZS1pbnRmICRhc3NvY2lhdGVfaW50ZiAiCiAgICAgICAgZmkKCiAgICAgICAgaWYgWyAtbiAiJGRpc3NvY2lhdGVfaW50ZiIgXSA7IHRoZW4KICAgICAgICAgICAgZmFpbG92ZXJfYXJncys9Ii0tZGlzc29jaWF0ZS1pbnRmICRkaXNzb2NpYXRlX2ludGYgIgogICAgICAgIGZpCiAgICBmaQoKICAgICMjIE1ha2Ugc3VyZSB0aGUgc2Vjb25kYXJ5IHByaXZhdGUgSVAgYWRkcmVzcyBpcyBhIFNlbGYgSVAKICAgIHRtc2ggbGlzdCBuZXQgc2VsZiB8IGdyZXAgIiRwcml2YXRlX2lwIgogICAgaWYgW1sgJD8gIT0gMCBdXTsgdGhlbgogICAgICAgIHRtc2ggY3JlYXRlIG5ldCBzZWxmIGxpY19tYW5hZ2VyIHZsYW4gaW50ZXJuYWwgYWxsb3ctc2VydmljZSBkZWZhdWx0IGFkZHJlc3MgJHtwcml2YXRlX2lwfS8zMgogICAgZWxzZQogICAgICAgIGVjaG8gIkFwcGVhcnMgJHByaXZhdGVfaXAgaXMgYWxyZWFkeSBhIFNlbGYgSVAiCiAgICBmaQoKICAgICMjIENyZWF0ZSBpQ2FsbCBzY3JpcHQgYW5kIGhhbmRsZXIgdG8gaGFuZGxlIGZhaWxvdmVyCiAgICBmYWlsb3Zlcl9zY3JpcHRfbG9jPSIvY29uZmlnL2Nsb3VkLyR7Y2xvdWR9L25vZGVfbW9kdWxlcy9AZjVkZXZjZW50cmFsL2Y1LWNsb3VkLWxpYnMtJHtjbG91ZH0vc2NyaXB0cy9mYWlsb3Zlci5qcyIKICAgIGljYWxsX2hhbmRsZXJfbmFtZT0iRmFpbG92ZXJIYW5kbGVyIgogICAgaWNhbGxfc2NyaXB0X25hbWU9IkZhaWxvdmVyQ29sbGVjdG9yIgogICAgIyMgRmlyc3QgY2hlY2sgaWYgaUNhbGwgYWxyZWFkeSBleGlzdHMKICAgIHRtc2ggbGlzdCBzeXMgaWNhbGwgaGFuZGxlciB8IGdyZXAgJGljYWxsX2hhbmRsZXJfbmFtZQogICAgaWYgW1sgJD8gIT0gMCBdXTsgdGhlbgogICAgICAgIHRtc2ggY3JlYXRlIHN5cyBpY2FsbCBzY3JpcHQgJGljYWxsX3NjcmlwdF9uYW1lIGRlZmluaXRpb24geyBpZiB7IFtjYXRjaCB7c2V0IGlzX2ZhaWxvdmVyX3J1bm5pbmcgW2V4ZWMgcGdyZXAgLWYgICIkZmFpbG92ZXJfc2NyaXB0X2xvYyJdfV0gfSB7IGV4ZWMgbm9kZSAkZmFpbG92ZXJfc2NyaXB0X2xvYyAkZmFpbG92ZXJfYXJncyB9IGVsc2UgeyBwdXRzICIkaWNhbGxfc2NyaXB0X25hbWUgaXMgYWxyZWFkeSBydW5uaW5nIHdpdGggUElEICRpc19mYWlsb3Zlcl9ydW5uaW5nIiB9IH0KICAgICAgICB0bXNoIGNyZWF0ZSBzeXMgaWNhbGwgaGFuZGxlciBwZXJpb2RpYyAvQ29tbW9uLyRpY2FsbF9oYW5kbGVyX25hbWUgeyBmaXJzdC1vY2N1cnJlbmNlIG5vdyBpbnRlcnZhbCA2MCBzY3JpcHQgL0NvbW1vbi8kaWNhbGxfc2NyaXB0X25hbWUgfQogICAgZWxzZQogICAgICAgIGVjaG8gIkFwcGVhcnMgdGhlICRpY2FsbF9oYW5kbGVyX25hbWUgaWNhbGwgYWxyZWFkeSBleGlzdHMhIgogICAgZmkKZmkKCnRtc2ggc2F2ZSBzeXMgY29uZmln"											
										]
									]
								}
							}
						}
					}
				}
			},
			"Properties": {
				"BlockDeviceMappings": [{
						"DeviceName": "/dev/xvda",
						"Ebs": {
							"DeleteOnTermination": "true",
							"VolumeType": "gp2"
						}
					},
					{
						"DeviceName": "/dev/xvdb",
						"NoDevice": {

						}
					}
				],
				"IamInstanceProfile": {
					"Ref": "deviceS3ArnProfile"
				},
				"ImageId": {
					"Fn::If": [
						"noCustomImageId",
						{
							"Fn::FindInMap": [
								"regionMap",
								{
									"Ref": "AWS::Region"
								},
								"Best"
							]
						},
						{
							"Ref": "customImageId"
						}
					]
				},
				"InstanceType": {
					"Ref": "instanceType"
				},
				"KeyName": {
					"Ref": "sshKey"
				},
				"NetworkInterfaces": [{
						"Description": "Management Interface",
						"DeviceIndex": "0",
						"NetworkInterfaceId": {
							"Ref": "device1ManagementInterface"
						}
					},
					{
						"Description": "Private or Internal Interface",
						"DeviceIndex": "1",
						"NetworkInterfaceId": {
							"Ref": "device1subnet1Az1Interface"
						}
					}
				],
				"Tags": [{
						"Key": "Application",
						"Value": {
							"Ref": "application"
						}
					},
					{
						"Key": "Costcenter",
						"Value": {
							"Ref": "costcenter"
						}
					},
					{
						"Key": "Environment",
						"Value": {
							"Ref": "environment"
						}
					},
					{
						"Key": "Group",
						"Value": {
							"Ref": "group"
						}
					},
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"", [
									"Instance: ",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					},
					{
						"Key": "Owner",
						"Value": {
							"Ref": "owner"
						}
					}
				],
				"UserData": {
					"Fn::Base64": {
						"Fn::Join": [
							"", [
								"#!/bin/bash\n",
								"/opt/aws/apitools/cfn-init-1.4-0.amzn1/bin/cfn-init -v -s ",
								{
									"Ref": "AWS::StackId"
								},
								" -r ",
								"device1Instance",
								" --region ",
								{
									"Ref": "AWS::Region"
								},
								"\n"
							]
						]
					}
				}
			},
			"Type": "AWS::EC2::Instance"
		},
		"device1ManagementEipAddress": {
			"Properties": {
				"Domain": "vpc"
			},
			"Type": "AWS::EC2::EIP"
		},
		"device1ManagementEipAssociation": {
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"device1ManagementEipAddress",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "device1ManagementInterface"
				}
			},
			"Type": "AWS::EC2::EIPAssociation"
		},
		"device1subnet1Az1EipAddress": {
			"Properties": {
				"Domain": "vpc"
			},
			"Type": "AWS::EC2::EIP"
		},
		"device1subnet1Az1EipAssociation": {
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"device1subnet1Az1EipAddress",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "device1subnet1Az1Interface"
				}
			},
			"Type": "AWS::EC2::EIPAssociation"
		},
		"device1ManagementInterface": {
			"Properties": {
				"Description": "Management Interface",
				"GroupSet": [{
					"Ref": "deviceManagementSecurityGroup"
				}],
				"SubnetId": {
					"Ref": "managementSubnetAz1"
				}
			},
			"Type": "AWS::EC2::NetworkInterface"
		},
		"device1subnet1Az1Interface": {
			"Properties": {
				"Description": "Private Interface for the the instance",
				"GroupSet": [{
					"Ref": "deviceInternalSecurityGroup"
				}],
				"SubnetId": {
					"Ref": "subnet1Az1"
				}
			},
			"Type": "AWS::EC2::NetworkInterface"
		},
		"deviceManagementSecurityGroup": {
			"Properties": {
				"GroupDescription": "management interface policy",
				"SecurityGroupIngress": [{
						"CidrIp": {
							"Ref": "restrictedSrcAddress"
						},
						"FromPort": "22",
						"IpProtocol": "tcp",
						"ToPort": "22"
					},
					{
						"CidrIp": {
							"Ref": "restrictedSrcAddress"
						},
						"FromPort": "443",
						"IpProtocol": "tcp",
						"ToPort": "443"
					}
				],
				"Tags": [{
						"Key": "Application",
						"Value": {
							"Ref": "application"
						}
					},
					{
						"Key": "Costcenter",
						"Value": {
							"Ref": "costcenter"
						}
					},
					{
						"Key": "Environment",
						"Value": {
							"Ref": "environment"
						}
					},
					{
						"Key": "Group",
						"Value": {
							"Ref": "group"
						}
					},
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"", [
									"Management Security Group:",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					},
					{
						"Key": "Owner",
						"Value": {
							"Ref": "owner"
						}
					}
				],
				"VpcId": {
					"Ref": "Vpc"
				}
			},
			"Type": "AWS::EC2::SecurityGroup"
		},
		"deviceInternalSecurityGroup": {
			"Properties": {
				"GroupDescription": "internal interface policy",
				"SecurityGroupIngress": [{
						"CidrIp": {
							"Ref": "restrictedSrcAddressApp"
						},
						"FromPort": "443",
						"IpProtocol": "tcp",
						"ToPort": "443"
					}
				],
				"Tags": [{
						"Key": "Application",
						"Value": {
							"Ref": "application"
						}
					},
					{
						"Key": "Costcenter",
						"Value": {
							"Ref": "costcenter"
						}
					},
					{
						"Key": "Environment",
						"Value": {
							"Ref": "environment"
						}
					},
					{
						"Key": "Group",
						"Value": {
							"Ref": "group"
						}
					},
					{
						"Key": "Name",
						"Value": {
							"Fn::Join": [
								"", [
									"Internal Security Group:",
									{
										"Ref": "AWS::StackName"
									}
								]
							]
						}
					},
					{
						"Key": "Owner",
						"Value": {
							"Ref": "owner"
						}
					}
				],
				"VpcId": {
					"Ref": "Vpc"
				}
			},
			"Type": "AWS::EC2::SecurityGroup"
		},
		"deviceS3ArnPolicy": {
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Statement": [
						{
							"Action": [
								"sts:AssumeRole"
							],
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"ec2.amazonaws.com"
								]
							}
						}
					],
					"Version": "2012-10-17"
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyDocument": {
							"Statement": [
								{
									"Effect": "Allow",
									"Action": [
										"s3:Get*",
										"s3:List*"
									],
									"Resource": {
										"Ref": "bigIqPasswordS3Arn"
									}
								}
							],
							"Version": "2012-10-17"
						},
						"PolicyName": "deviceS3ArnPolicy"
					}
				]
			},
			"Type": "AWS::IAM::Role"
		},
		"deviceS3ArnProfile": {
			"Properties": {
				"Path": "/",
				"Roles": [
					{
						"Ref": "deviceS3ArnPolicy"
					}
				]
			},
			"Type": "AWS::IAM::InstanceProfile"
		}
	}
}
